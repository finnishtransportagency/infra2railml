# Infra-API transformation to railML v2.2

Converts selected data sets from https://rata.digitraffic.fi/infra-api/0.3 to railML v2.2, mainly to be imported in OpenTrack simulation software.

## Requirements

- Git client
- Node.js v10.15.3
- NPM v6.4.1
- [NVM](https://github.com/creationix/nvm) is recommended for installing Node.js and NPM.

## Setup & Installation

- Clone the source code repository
    - `git clone <repository>`
- Go to infra2railml directory
- Install dependencies and create a symlink for the 
    - `npm install && npm link`
- Confirm the `infra2railml` command is found in PATH
    - `infra2railml --version`

## Usage

For general usage and options, see `infra2railml --help`.

### Railway Infrastucture

Infrastructure model is generated by by giving a track ID, first kilometer and last kilometer. The given kilometers are inclusive, but notice that all rails that span over the requested scope are also included with full length but fewer details. Desired track length may also be given instead of end kilometer. For example, track 007 kilometers 28 through 37 (i.e. 10 kilometers):

- `infra2railml 007 --from 28 --to 37`
- `infra2railml 007 --from 28 --length 10`

### Stations

- TODO

## Implementation Details

### Naming Conventions

The API and railML terminology is overlapping but in the API everything is given in Finnish. Hence, to avoid confusion, Finnish terms are generally used to refer to API structrues and variables, while English is used for railML and general code.

### Terminology Mapping

The terminology is mapped between Infra API and railML as follows:

|Infra API term             |Corresponding or related railML 2.2 terms      |Notes
|---                        |---                                            |---
|raide                      |track                                          |Also "rail" in source code.
|vaihde                     |switch                                         |elementti.vaihde
|raideristeys               |crossing                                       |elementti.vaihde
|baliisi                    |balise                                         |elementti.baliisi
|opastin                    |signal                                         |elementti.opastin
|kilometripaalu             |signal/milepost                                |Also "ratakilometri"
|sijainti (km + etaisyys)   |pos, absPos, mileageChange                     |Calculated relative to track begin
|raide-eristys              |electrificationChange                          |Is this correct?
|nopeusrajoitukset          |speedChange, infraAttributes/speed             |
|rautatieliikennepaikka     |ocp, platformEdge, stopPost                    |Also "station" in source code.

### Identifiers

The API identifies objects with unique identifiers given in the field `tunniste`. However, in railML it is common we also need to identify and reference various child elements nested under the main object element. Thus, to avoid artificial IDs and make it easier to refer children from other contexts, the IDs are prefixed with abbreviations based on object type. In some cases the IDs are also suffixed with abbreviations or position on track to ensure the uniqueness of IDs. For example,

|Object/Child                   |Infra-API object ID            |Corresponding railML ID
|---                            |---                            |---
|track                          |x.x.xxx.LIVI.INFRA.44.117326   |x.x.xxx.LIVI.INFRA.44.117326	
|track/trackBegin               |-                              |tb_x.x.xxx.LIVI.INFRA.44.117326
|track/trackBegin/connection    |-                              |tbc_x.x.xxx.LIVI.INFRA.44.117326
|track/trackEnd                 |-                              |te_x.x.xxx.LIVI.INFRA.44.117326
|track/trackEnd/connection      |-                              |tec_x.x.xxx.LIVI.INFRA.44.117326
|switch                         |x.x.xxx.LIVI.INFRA.24.102936   |x.x.xxx.LIVI.INFRA.24.102936
|switch/connection              |-                              |swc_x.x.xxx.LIVI.INFRA.24.102936

The above is only to give the general idea, in practice there are many more.

### Tracks

Each individual rail (raide) from Infra API will result in railML track element, including the chosen track elements and features. Track begin and end connections are from track to track (main tracks, track end referencing the beginning of next track) or from track to switch (side tracks, track begin or end referencing a switch or crossing). Track may also be left open-ended if they reach outside of requested track scope or be terminated with a buffer stop.

### Switches

Switches allow defining three connections, but we've been following the style that OpenTrack is using and thus all switches contain only one connection/reference to a track, which is always the parting direction of the switch (left/right). Hence, the straight direction tracks always refer each other directly from end to beginning. Due to this, switches must always be nested under the main tracks, or otherwise the parting direction is left dangling without a clear connection to the main track. The switches received from Infra API are always examined using the rising direction (nouseva).

### Signals

Signals are positioned in `tracks` using the `pos` and `absPos` attributes. The Infra API does not provide information about blocking, home and exit signals. Thus we assume that all signal that are not related to any station (rautatieliikennepaikka) are blocking. Signals related to stations are always modeled as being "exit". Therefore, the home signals should be fixed by the user by switching the certain exit signals to home.

### Mileposts, Mileages and Positions

Mileposts are special signals including a `milepost` child element, but otherwise they're similar to regular signals. The milepost signal represents the real posts that are placed along the tracks, and thus the distance between them may not be exactly 1000 meters. Hence, when requesting a portion of a track, say lenght of 10 kilometers, the actual returned track lenght may be different. Because of this, all `pos` attribute values must be calculated using all the involved track kilometers, which is handled by the [position-utils](./utils/position-utils.js) module. This applyes also for the `mileageChange` elemenets that are used to define "jumps" or "missing parts" in the track length.

### Crossings

Crossings are slightly problematic to map, because most often the Infra API defines the connections as non-breaking for both directions A-C and B-D (i.e. single rail runs through the crossing). Because of this, while we can model the other direction as implicit so that crossing is simply placed along the A-C direction `track`, we cannot unambiguosly define the connections for B-D, as the data defines only one rail which cannot be referenced.

### Speed Limits

Speed limits are collected from each rail and nested as `track` children. The speed categories are generated from the exact same data and nested under railML infrastructure element. It is quite common for Infra API to not defined the direction of speed limits. When no direction is given, we assume equal limits in both directions and position the `speedChange` elements with limit begin (up) and end (down) positions. Otherwise, only the given direction is used and the begin position is used.